---
title: "Exploring extremes values (ES and SD)"
format:
  docx:
    toc: false
    number-sections: false
execute: 
  echo: false
  warning: false
---

#### Load packages 

```{r}
library(tidyverse)      # Data wrangling
library(metafor)        # Meta-analysis
library(readxl)         # Read Excel files
library(extrafont)      # Additional fonts
library(cowplot)        # Plot annotation and alignment
library(patchwork)      # Combine plots
```

```{r}
# Import data from Excel
df <- read_excel("../data/Dataclean_200FST.xlsx") 

# Change date type to numeric
df <- df  |>  
  mutate(year = as.numeric(format(as.Date(df$year, format = "%d/%m/%Y"),"%Y"))) 

```

#### Calculate effect size in standardized mean difference (Hedges' g)

```{r}
Efeito <- escalc(measure = "SMD", n1i = ctr_n_corr, n2i = atd_n_round, m1i = ctr_mean, m2i = atd_mean, 
                 sd1i = ctr_sd, sd2i = atd_sd, data = df, 
                 append = TRUE)
```

#### EXPLORATORY ANALYSIS OF EXTREME EFFECTS ----

```{r}
extreme_studies <- Efeito |> 
  mutate(sd = sqrt(vi)) |> 
  filter(sd >= 3 & yi >= 5)
```

#### How many studies has a effect size \>= 5 and sd \>=3? How much % they represent of the library?

```{r}
extreme_studies_quant <- Efeito |>  
  mutate(sd = sqrt(vi)) |> 
  filter(sd >= 3 & yi >= 5) |> 
  summarise(count = n(),
            pcent = ((count * 100) / nrow(Efeito)))

print(paste("There are", extreme_studies_quant$count, "studies with extremes ES and SD, representing", format(extreme_studies_quant$pcent, digits = 4), "% of the total."))
```

#### How many publications they represent? are they nested?

```{r}
extreme_pub_species <- extreme_studies |> 
  group_by(species, id) |> 
  summarise(count = n()) |> 
  arrange(desc(count)) 

extreme_pub_species 

extreme_pub_species |> 
  ggplot2::ggplot(aes(y = count, x = reorder(id, count), fill = as.factor(species))) + 
  geom_col() + 
  scale_fill_manual(values = c("mice" = "orange", "rat" = "red")) +
  coord_flip() +
  theme_bw()
  
```

#### All studies from these publications present a extreme effect size?

## mice

```{r}
Efeito |> mutate(sd = sqrt(vi)) |> 
  filter(id %in% extreme_studies$id) |> 
  mutate(extreme_or_not = case_when(
    sd >= 3 & yi >= 5 ~ TRUE,
    .default = FALSE
  )) |> 
  group_by(species, id, extreme_or_not) |> 
  count() |> 
  filter(species == "mice") |> 
  ggplot2::ggplot(aes(y = n, x = reorder(id, n), fill = as.factor(extreme_or_not))) + 
  geom_col() +
  scale_fill_manual(values = c("FALSE" = "grey", "TRUE" = "orange")) +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "bottom")
```

## rat

```{r}
Efeito |> mutate(sd = sqrt(vi)) |> 
  filter(id %in% extreme_studies$id) |> 
  mutate(extreme_or_not = case_when(
    sd >= 3 & yi >= 5 ~ TRUE,
    .default = FALSE
  )) |> 
  group_by(species, id, extreme_or_not) |> 
  count() |> 
  filter(species == "rat") |> 
  ggplot2::ggplot(aes(y = n, x = reorder(id, n), fill = as.factor(extreme_or_not))) + 
  geom_col() +
  scale_fill_manual(values = c("FALSE" = "grey", "TRUE" = "red")) +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "bottom")
```

#### What are the characteristics of these studies?

## pop:

```{r}
#| layout-nrow: 2

extreme_studies |> 
  filter(species == "mice") |> 
  select(sex, strain, bioterium_lightcycle) |> 
  gather(key = "variable", value = "value") |> 
  count(variable, value) |> 
  arrange(variable, desc(n))  |> 
  ggplot2::ggplot(aes(y = n, x = reorder(value, n), fill = as.factor(value))) + 
  geom_col() +
  facet_wrap(~variable, scales = "free_y") +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "none",
        axis.title.y = element_blank())

extreme_studies |> 
  filter(species == "rat") |> 
  select(sex, strain, bioterium_lightcycle) |> 
  gather(key = "variable", value = "value") |> 
  count(variable, value) |> 
  arrange(variable, desc(n))  |> 
  ggplot2::ggplot(aes(y = n, x = reorder(value, n), fill = as.factor(value))) + 
  geom_col() +
  facet_wrap(~variable, scales = "free_y") +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "none",
        axis.title.y = element_blank())
```

## int:

```{r}
extreme_studies |> 
  filter(species == "mice") |> 
  select(atd_class, atd_type, treatment_via) |> 
  gather(key = "variable", value = "value") |> 
  count(variable, value) |> 
  arrange(variable, desc(n))  |> 
  ggplot2::ggplot(aes(y = n, x = reorder(value, n), fill = as.factor(value))) + 
  geom_col() +
  facet_wrap(~variable, scales = "free_y") +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "none",
        axis.title.y = element_blank())


extreme_studies |> 
  filter(species == "rat") |> 
  select(atd_class, atd_type, treatment_via) |> 
  gather(key = "variable", value = "value") |> 
  count(variable, value) |> 
  arrange(variable, desc(n))  |> 
  ggplot2::ggplot(aes(y = n, x = reorder(value, n), fill = as.factor(value))) + 
  geom_col() +
  facet_wrap(~variable, scales = "free_y") +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "none",
        axis.title.y = element_blank())
```

## out:

```{r}
extreme_studies |> 
  filter(species == "mice") |> 
  select(fst_protocol, measurement_method) |> 
  gather(key = "variable", value = "value") |> 
  count(variable, value) |> 
  arrange(variable, desc(n))  |> 
  ggplot2::ggplot(aes(y = n, x = reorder(value, n), fill = as.factor(value))) + 
  geom_col() +
  facet_wrap(~variable, scales = "free_y") +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "none",
        axis.title.y = element_blank())


extreme_studies |> 
  filter(species == "rat") |> 
  select(fst_protocol, measurement_method) |> 
  gather(key = "variable", value = "value") |> 
  count(variable, value) |> 
  arrange(variable, desc(n))  |> 
  ggplot2::ggplot(aes(y = n, x = reorder(value, n), fill = as.factor(value))) + 
  geom_col() +
  facet_wrap(~variable, scales = "free_y") +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "none",
        axis.title.y = element_blank())
```

## validity:

```{r}
extreme_studies |> 
  filter(species == "mice") |> 
  select(rob1:rob10) |> 
  gather(key = "variable", value = "value") |> 
  count(variable, value) |> 
  arrange(variable, desc(n))  |> 
  ggplot2::ggplot(aes(y = n, x = reorder(value, n), fill = as.factor(value))) + 
  geom_col() +
  scale_fill_manual(values = c("No" = "red", "Unclear" = "gold", "Yes" = "green3")) +
  facet_wrap(~ variable, scales = "free_y", ncol = 5) +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "none",
        axis.title.y = element_blank())

extreme_studies |> 
  filter(species == "rat") |> 
  select(rob1:rob10) |> 
  gather(key = "variable", value = "value") |> 
  count(variable, value) |> 
  arrange(variable, desc(n))  |> 
  ggplot2::ggplot(aes(y = n, x = reorder(value, n), fill = as.factor(value))) + 
  geom_col() +
  scale_fill_manual(values = c("No" = "red", "Unclear" = "gold", "Yes" = "green3")) +
  facet_wrap(~ variable, scales = "free_y", ncol = 5) +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "none",
        axis.title.y = element_blank())
```

##### What's the effect size from the studies that reported not doing practices to ganrantee internal quality?

```{r}
rob_no <- Efeito |> mutate(sd = sqrt(vi)) |>
    filter(
      rob1 == "No"
      |rob2 == "No"
      |rob3 == "No"
      |rob4 == "No"
      |rob5 == "No"
      |rob6 == "No"
      |rob7 == "No"
      |rob8 == "No"
      |rob9 == "No"
      |rob10 == "No") 

rob_no |> 
  summarise(min = min(yi),
            max = max(yi),
            mean = mean(yi),
            median = median(yi),
            min_sd = min(sd),
            max_sd = max(sd),
            mean_sd = mean(sd),
            median_sd = median(sd)) |> as.tibble()
```

```{r}
rob_no |>  
  pivot_longer(cols = c("yi", "sd"), names_to = "var", values_to = "value") |> ggplot(aes(x = value)) + 
  geom_histogram(binwidth = 1) + 
  facet_wrap(~var, scales = "free_x") +
  theme_bw()
```

#### Are these studies nested?

```{r}
rob_no |> group_by(id) |> count() |> arrange(desc(n)) |>  print(n = 21)
```

#### Are these studies considered extremes?

```{r}
rob_no_extreme <- rob_no |> 
  mutate(extreme_or_not = case_when(
    id %in% extreme_studies$id ~ TRUE,
    .default = FALSE
  )) 

rob_no_extreme |> 
  count(extreme_or_not)
```
